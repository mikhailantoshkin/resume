<!DOCTYPE html>
<html lang="en-us">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta itemprop="name" content="Mikhail Antoshkin" />
  <meta itemprop="description" content="" />

  <link rel="apple-touch-icon" sizes="180x180" href="https://mikhailantoshkin.github.io/blog/apple-touch-icon.png"/>
  <link rel="icon" type="image/png" sizes="32x32" href="https://mikhailantoshkin.github.io/blog/favicon-32x32.png" />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://mikhailantoshkin.github.io/blog/favicon-16x16.png"
  />
  <link
    rel="shortcut icon"
    href="https://mikhailantoshkin.github.io/blog/favicon.ico"
  />
  <link rel="stylesheet" href="https://mikhailantoshkin.github.io/blog/style.css"/>
  
  <title>How to freeze a pool</title>
  

  

  <body id="page">

	
<header id="site-header" class="animated slideInUp faster">
  <div class="hdr-wrapper section-inner">
    <div class="hdr-left">
      <div class="site-branding">
        <a href="https:&#x2F;&#x2F;mikhailantoshkin.github.io&#x2F;blog">Home</a>
      </div>
      <nav class="site-nav hide-in-mobile">
            
        
        <a href="https://mikhailantoshkin.github.io/blog/posts">Posts</a>
        
        <a href="https://mikhailantoshkin.github.io/blog/resume">Resume</a>
        
      </nav>
    </div>
    <div class="hdr-right hdr-icons">
      <span class="hdr-social hide-in-mobile">
        

<a href="https:&#x2F;&#x2F;twitter.com&#x2F;mike_antoshkin" target="_blank" rel="noopener me"
   title="twitter">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;github.com&#x2F;mikhailantoshkin" target="_blank" rel="noopener me"
   title="github">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
  
</a>

<a href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;mikhail-antoshkin&#x2F;" target="_blank" rel="noopener me"
   title="linkedin">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
  
</a>

<a href="mike.antoshkin@gmail.com" target="_blank" rel="noopener me"
   title="email">
  
  <svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
  
</a>


      </span>
      <button id="menu-btn" class="hdr-btn" title="Menu">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="feather feather-menu"
        >
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
    </div>
  </div>
</header>
<div id="mobile-menu" class="animated fast">
  <ul>
    
    <li><a href="https://mikhailantoshkin.github.io/blog/posts">Posts</a></li>
    
    <li><a href="https://mikhailantoshkin.github.io/blog/resume">Resume</a></li>
    
  </ul>
</div>

	
	

		
<main class="site-main section-inner animated fadeIn faster">
  <article class="thin">
	<header class="post-header">
	  <div class="post-meta">
		
		<span>Jun 26, 2022</span>
		<small> - 
<span class="reading-time" title="Estimated read time">
  
  3 min read
  
</span>
</small>
		
            
	  </div>
	  <h1>How to freeze a pool</h1>
	</header>

	<div class="content">
        
	  <blockquote>
<p>Originally this was a part of <a href="https://mikhailantoshkin.github.io/blog/posts/python-is-easy/">Python is easy</a> article, but it quickly grew way to big
for a tangent, so I've decided to give it its own place under the sun. </p>
</blockquote>
<p>Let's imagine you are running a <code>multiprocessing.Pool</code> and want some clever stuff to happen when your worker terminates.
You should set up a signal handler with <a href="https://docs.python.org/3/library/signal.html?highlight=signal#module-signal">signal</a> module
like this, and you'll be good to go</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">def _handle_signal(sig: int, frame: Any) -&gt; None:
    logger.info(f&#x27;Received signal {sig}&#x27;)
    _cleanup()
    sys.exit()


signal.signal(signal.SIGINT, _handle_signal)
signal.signal(signal.SIGTERM, _handle_signal)
</code></pre>
<p>As you probably know, <code>sys.exit()</code> just raises <code>SystemExit</code>, so what happens when you raise some other exceptions?
First of all, <del>all hell breaks loose</del> you really should not do that. But if it happens to be a subclass of <code>Exception</code>
it will deadlock the pool.</p>
<p><em>Almost</em> all exceptions in python are subclasses of <code>Exception</code> class. It makes it very easy to just write</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">try:
    func()
except Exception:
    logger.exception(&#x27;Oh-oh something went wrong:&#x27;)
    raise
</code></pre>
<p>But there was one big caveat. And this caveat was <code>CancelledError</code>. In <code>asyncio</code>, python built-in async library,
<code>CancelledError</code> signals cancellation of a coroutine or a task and can be raised on basically any <code>await</code>. So, if 
your particular workload needs to do some cleanup or logging before exiting you do it like this</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">try:
    await afunc()
except CancelledError:
    # do some cleanup 
    raise
</code></pre>
<p>But this popular pattern suddenly becomes a problem.</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">try:
    await afunc()
except Exception:
    pass
</code></pre>
<p>Why? Because until Python 3.8 <code>CancelledError</code> was a subclass of <code>Exception</code>. It would just straight up ignore a 
cancellation of a coroutine. And it becomes extremely dangerous when event loop is stopping, since it has to 
cancel all currently scheduled coroutines.</p>
<p>So async code was riddled with stuff like this:</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">try:
    await afunc()
except CancelledError:
    raise
except SomeException:
    logger.info(&#x27;bad&#x27;)
</code></pre>
<p>Now <code>CancelledError</code> is a subclass of <code>BaseException</code>, so there is no need to check for it every time you want to
recover from an exception. </p>
<p>But why all this tangent about <code>CancelledError</code>? Well, you see, problem with deadlock in the <code>multiprocessing.Pool</code> revolves around similar issue.
When you create a pool it starts several management threads to deal with queues and what not. And it 
also spawns worker processes, running a special <a href="https://github.com/python/cpython/blob/3.10/Lib/multiprocessing/pool.py#L97">worker function</a>. 
It roughly looks like this, minus exception handling and setup part.</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">def worker(inqueue, outqueue, initializer=None, initargs=(), maxtasks=None):
    completed = 0
    while maxtasks is None or (maxtasks and completed &lt; maxtasks):

        task = get()  # Get a job to execute
        
        if task is None:
            util.debug(&#x27;worker got sentinel -- exiting&#x27;)
            break

        job, i, func, args, kwds = task
        try:
            result = (True, func(*args, **kwds))  # Runs a function submitted with .apply()
        except Exception as e:
            result = (False, e)  # Stores the exception as the result to send back to the parent process
        
        put((job, i, result))  # Puts the result in finished queue
        
        # Remove references, so the data will not linger on the next iteration
        task = job = result = func = args = kwds = None  
        completed += 1
    util.debug(&#x27;worker exiting after %d tasks&#x27; % completed)
</code></pre>
<p>When pool shuts down is sends <code>SIGTERM</code> to workers, and then joins them, so it won't leave any zombies.
But when you register a signal handler inside a worker process that raises some subclass of <code>Exception</code>, worker, in fact,
does not terminate. It just sends your exceptions as a result and waits for more work to come its way. But pool has already
closed all management threads and now is waiting for worker to exit. Classic deadlock. </p>
<p>So yeah, be careful with setting signal handlers in worker processes. Actually, it's just one of many caveats you need 
to be wary about when using multiprocessing in Python. Some of them are described in 
<a href="https://pythonspeed.com/articles/python-multiprocessing/">this article</a>. </p>
<h2 id="and-one-more-thing">And one more thing</h2>
<p>As documentation for signal module <a href="https://docs.python.org/3/library/signal.html?highlight=signal#note-on-signal-handlers-and-exceptions">states</a>,
if signal handler raises an exception it can be executed after <em>any</em> bytecode instruction on the main thread. So with this
bit of information, where the memory leak occurs in <code>_wait_response</code> method?</p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">class Client:
    def __init__(self):
        # snip
        self._responses: Dict[str, Any] = {}
        self._response_events: Dict[str, Event] = {}

    # snip
    def _wait_response(self, correlation_id: str, expiration: int) -&gt; Dict:
        if not self._response_events[correlation_id].wait(expiration):
            self._response_events.pop(correlation_id)
            raise TimeoutError
        self._response_events.pop(correlation_id)
        return self._responses.pop(correlation_id)
</code></pre>
<p>It's a trick question. Because there is no memory leak. </p>
<p>Yet. </p>
<p>If you set up a signal handler for <code>SIGALARM</code> like this for the worker process running <code>Client</code></p>
<pre data-lang="python" class="language-python "><code class="language-python" data-lang="python">def raise_timeout_error(signal, frame):
    raise RuntimeError(&quot;Time is up!&quot;)

signal.signal(signal.SIGALRM, raise_timeout_error)
signal.alarm(_timeout)
</code></pre>
<p>You will leak <code>Event</code> instances in the <code>_response_events</code> dict. If your <code>expiration</code> for <code>wait</code> method on <code>Event</code> happens 
to be a bit longer (or equal, for that matter) than <code>_timeout</code> on <code>SIGALARM</code>, <code>RuntimeError</code> will be raised from 
<code>wait(expiration)</code> call. Because <code>RuntimeError</code> is subclass of <code>Exception</code>, worker will not terminate on it, and you will
skip the resource cleanup code.</p>
<p>So yeah, your process pool <em>is</em> full of sharks, and you are the one who released them.</p>

	</div>
	<hr class="post-end">
	<footer class="post-info">
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>862 Words</p>
    
    <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2022-06-26</p>
    
	</footer>
  </article>
    
  
  <div class="post-nav thin">
	
	
  </div>

  
</main>

	  </div>
	  
	  



<footer id="site-footer" class="section-inner thin animated fadeIn faster">
  <p>&copy; 2023 <a href="https:&#x2F;&#x2F;mikhailantoshkin.github.io&#x2F;blog">Mikhail Antoshkin</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
  <p>Made with <a href="https://www.getzola.org" target="_blank" rel="noopener">Zola</a> &#183; Theme <a href="https://github.com/VersBinarii/hermit_zola" target="_blank" rel="noopener">Hermit_Zola</a>
	
  </p>
</footer>




	</div>
	
	<script src="https://mikhailantoshkin.github.io/blog/js/main.js"></script>

	<!-- Math rendering -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"
        onload="renderMathInElement(document.body, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}]});"></script>

    
		<link href="https://unpkg.com/highlightjs-badge/highlightjs/styles/vs2015.css" rel="stylesheet">
		<!-- https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.1.1/build/styles/  for min version -->
		<script src="https://unpkg.com/highlightjs-badge/highlightjs/highlight.pack.js"></script>
		<script src="https://unpkg.com/highlightjs-badge/highlightjs-badge.min.js"></script>
		<script>
			var pres = document.querySelectorAll("pre>code");
			for (var i = 0; i < pres.length; i++) {
				hljs.highlightBlock(pres[i]);
			}
		</script>
		
			<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
			<script>
				var options = {
					copyIconClass: "gg-clipboard",
					checkIconClass: "gg-check"
				};
				window.highlightJsBadge(options);
			</script>
		

	

	
	<script src="https://mikhailantoshkin.github.io/blog/js/main.js"></script>

    
    

	
  </body>
</html>
